# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

## ğŸŒ æ–¹æ¡ˆæ¦‚è¿°

**éƒ¨ç½²æ¶æ„**ï¼š
- åŸŸåï¼š`3b.1plabs.pro`
- Nginx Proxy Managerï¼ˆNPMï¼‰åå‘ä»£ç†
- å‰ç«¯ï¼šç«¯å£ 20001ï¼ˆç›‘å¬ 0.0.0.0ï¼‰
- åç«¯ï¼šç«¯å£ 20002ï¼ˆä»…ç›‘å¬ 127.0.0.1ï¼‰
- API è®¿é—®ï¼šé€šè¿‡åŒåŸŸ `/api` è·¯å¾„åä»£åˆ°åç«¯

**ä¼˜ç‚¹**ï¼š
- âœ… åç«¯ä¸ç›´æ¥æš´éœ²ç»™å…¬ç½‘
- âœ… é¿å… CORS è·¨åŸŸé—®é¢˜
- âœ… ç»Ÿä¸€åŸŸåç®¡ç† SSL è¯ä¹¦
- âœ… ç¬¦åˆç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ

---

## âš ï¸ ç”Ÿäº§ç¯å¢ƒé‡è¦è¯´æ˜

### ğŸš« ç¦æ­¢ä½¿ç”¨å¼€å‘æœåŠ¡å™¨

**ä¸¥ç¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ `npm run dev`**

**åŸå› **ï¼š
1. **å®‰å…¨é£é™©**ï¼šVite dev server æš´éœ²æºç ã€HMR ç«¯ç‚¹ã€å¼€å‘å·¥å…·
2. **Host æ ¡éªŒ**ï¼šdev server æœ‰ä¸¥æ ¼çš„ Host å¤´éªŒè¯ï¼Œä¼šå¯¼è‡´ 502 é”™è¯¯
3. **æ€§èƒ½é—®é¢˜**ï¼šå®æ—¶ç¼–è¯‘æ¶ˆè€—èµ„æºï¼Œä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ
4. **ç¨³å®šæ€§å·®**ï¼šç¼ºä¹è¿›ç¨‹å®ˆæŠ¤ï¼Œå®¹æ˜“å› é”™è¯¯é€€å‡º

**æ­£ç¡®åšæ³•**ï¼š
- âœ… æœ¬åœ°å¼€å‘ï¼š`npm run dev`
- âœ… ç”Ÿäº§éƒ¨ç½²ï¼š`npm run build` + `npm run preview`
- âœ… æˆ–ä½¿ç”¨ Nginx ç›´æ¥æ‰˜ç®¡ `dist/` é™æ€æ–‡ä»¶

### ğŸ›¡ï¸ æ¨èä½¿ç”¨ PM2 å®ˆæŠ¤è¿›ç¨‹

**ä¸ºä»€ä¹ˆéœ€è¦ PM2**ï¼š
- è‡ªåŠ¨é‡å¯ï¼šè¿›ç¨‹å´©æºƒåè‡ªåŠ¨æ¢å¤
- æ—¥å¿—ç®¡ç†ï¼šç»Ÿä¸€æ”¶é›†è¾“å‡ºå’Œé”™è¯¯æ—¥å¿—
- å¼€æœºè‡ªå¯ï¼šæœåŠ¡å™¨é‡å¯åè‡ªåŠ¨å¯åŠ¨åº”ç”¨
- é›¶åœæœºéƒ¨ç½²ï¼šæ”¯æŒä¼˜é›…é‡å¯

**å¿«é€Ÿå¼€å§‹**ï¼š
```bash
# å®‰è£… PM2ï¼ˆå¦‚æœªå®‰è£…ï¼‰
npm install -g pm2

# ä¸€é”®å¯åŠ¨å‰åç«¯ï¼ˆæ¨èï¼‰
./pm2-manager.sh start

# æŸ¥çœ‹çŠ¶æ€
./pm2-manager.sh status

# æŸ¥çœ‹æ—¥å¿—
./pm2-manager.sh logs
```

è¯¦ç»†è¯´æ˜è§ä¸‹æ–¹ [PM2 æŒä¹…åŒ–è¿è¡Œ](#pm2-æŒä¹…åŒ–è¿è¡Œæ¨è) ç« èŠ‚ã€‚

---

## ğŸ“‹ éƒ¨ç½²æ­¥éª¤

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ PM2ï¼ˆæ¨èï¼‰

```bash
cd /home/lanlic/Html-Project/3b-manage/game-manager

# 1. å®‰è£… PM2ï¼ˆå¦‚æœªå®‰è£…ï¼‰
npm install -g pm2

# 2. å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆè‡ªåŠ¨æ„å»ºå‰ç«¯ï¼‰
./pm2-manager.sh start

# 3. æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
./pm2-manager.sh status

# 4. ä¿å­˜è¿›ç¨‹åˆ—è¡¨å¹¶é…ç½®å¼€æœºè‡ªå¯
./pm2-manager.sh setup
# ç„¶åæ‰§è¡Œè¾“å‡ºçš„ sudo å‘½ä»¤

# 5. æŸ¥çœ‹å®æ—¶æ—¥å¿—
./pm2-manager.sh logs
```

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨å¯åŠ¨ï¼ˆä¸æ¨èç”Ÿäº§ä½¿ç”¨ï¼‰

ä»…ç”¨äºä¸´æ—¶æµ‹è¯•æˆ–å¼€å‘ç¯å¢ƒã€‚

### 1. åç«¯æœåŠ¡å¯åŠ¨

```bash
cd /home/lanlic/Html-Project/3b-manage/game-manager

# ä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆè‡ªåŠ¨æ£€æŸ¥ç«¯å£å†²çªï¼‰
./start-backend.sh

# æˆ–è€…æ‰‹åŠ¨å¯åŠ¨
cd server
npm start
```

åç«¯å°†ç›‘å¬ `127.0.0.1:20002`ï¼ˆä»…æœ¬åœ°å¯è®¿é—®ï¼‰ã€‚

### 2. å‰ç«¯æ„å»ºä¸å¯åŠ¨

```bash
cd /home/lanlic/Html-Project/3b-manage/game-manager

# ä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆè‡ªåŠ¨æ„å»º+é¢„è§ˆï¼‰
./start-frontend.sh

# æˆ–è€…æ‰‹åŠ¨æ“ä½œ
cd client
npm run build
npm run preview
```

å‰ç«¯å°†åœ¨ `0.0.0.0:20001` è¿è¡Œé¢„è§ˆæœåŠ¡å™¨ã€‚

### 3. Nginx Proxy Manager é…ç½®

ç™»å½• NPM ç®¡ç†ç•Œé¢ï¼ˆé€šå¸¸æ˜¯ `http://æœåŠ¡å™¨IP:9001`ï¼‰ã€‚

#### 3.1 é…ç½®ä¸»åŸŸåä»£ç†

**Proxy Hosts** â†’ **Add Proxy Host**

- **Domain Names**: `3b.1plabs.pro`
- **Scheme**: `http`
- **Forward Hostname / IP**: `127.0.0.1`
- **Forward Port**: `20001`
- **Cache Assets**: âœ… å¼€å¯ï¼ˆå¯é€‰ï¼‰
- **Block Common Exploits**: âœ… å¼€å¯
- **Websockets Support**: âœ… å¼€å¯ï¼ˆPWA éœ€è¦ï¼‰

**SSL é€‰é¡¹å¡**ï¼š
- **SSL Certificate**: é€‰æ‹©æˆ–ç”³è¯· Let's Encrypt è¯ä¹¦
- **Force SSL**: âœ… å¼€å¯
- **HTTP/2 Support**: âœ… å¼€å¯

#### 3.2 é…ç½® API åå‘ä»£ç†

åœ¨åŒä¸€ä¸ª Proxy Host ä¸­ï¼Œåˆ‡æ¢åˆ° **Custom Locations** é€‰é¡¹å¡ï¼š

**Add Location**ï¼š

- **Define Location**: `/api`
- **Scheme**: `http`
- **Forward Hostname / IP**: `127.0.0.1`
- **Forward Port**: `20002`
- **Forward Path**: `/api`ï¼ˆä¿æŒ API è·¯å¾„å‰ç¼€ï¼‰
- **Websockets Support**: âœ… å¼€å¯ï¼ˆå¯é€‰ï¼‰

**Advanced é…ç½®**ï¼ˆç²˜è´´åˆ°é…ç½®æ¡†ï¼‰ï¼š
```nginx
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_buffering off;
```

ç‚¹å‡» **Save** ä¿å­˜ã€‚

---

## âœ… éªŒè¯éƒ¨ç½²

### å¥åº·æ£€æŸ¥ï¼ˆæœ¬åœ°ï¼‰

```bash
cd /home/lanlic/Html-Project/3b-manage/game-manager
npm run healthcheck
```

é¢„æœŸè¾“å‡ºï¼š
```
ğŸŸ¢ Frontend http://localhost:20001/ OK
ğŸŸ¢ Backend  http://localhost:20002/api/meta OK
âœ… All services OK.
```

### å¤–ç½‘è®¿é—®æµ‹è¯•

1. **å‰ç«¯é¡µé¢**ï¼šæµè§ˆå™¨è®¿é—® `https://3b.1plabs.pro`
2. **API æµ‹è¯•**ï¼š
   ```bash
   curl https://3b.1plabs.pro/api/meta
   ```
   é¢„æœŸè¿”å›ï¼š
   ```json
   {"status":"ok","today":"2025-12-15","timestamp":"...","version":"2.0.0"}
   ```

3. **ç™»å½•åŠŸèƒ½**ï¼š
   - ç‚¹å‡»ã€ŒğŸ” æ€»ç£è¯·è¿›ã€
   - è¾“å…¥å¯†ç ï¼š`12345aBc`
   - éªŒè¯æ˜¯å¦èƒ½æ­£å¸¸ç™»å½•å’Œä½¿ç”¨ç®¡ç†åŠŸèƒ½

---

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

1. **é˜²ç«å¢™é…ç½®**ï¼š
   - ç¡®ä¿ 20002 ç«¯å£ä¸å¯¹å…¬ç½‘å¼€æ”¾
   - ä»…å…è®¸ 20001ã€443ï¼ˆHTTPSï¼‰ã€9001ï¼ˆNPMï¼‰å¿…è¦ç«¯å£

2. **åç«¯ç›‘å¬åœ°å€**ï¼š
   - å·²é…ç½®ä¸º `127.0.0.1`ï¼Œå¤–ç½‘æ— æ³•ç›´æ¥è®¿é—®
   - å¦‚éœ€å¤–ç½‘è®¿é—®ï¼Œè¯·åˆ é™¤ NPM API åä»£é…ç½®å¹¶ä¿®æ”¹åç«¯ç›‘å¬åœ°å€

3. **å¯†ç ç®¡ç†**ï¼š
   - é»˜è®¤ç®¡ç†å¯†ç ï¼š`12345aBc`
   - ç”Ÿäº§ç¯å¢ƒå»ºè®®ä¿®æ”¹ `server/routes/admin.js` ä¸­çš„å¯†ç éªŒè¯é€»è¾‘

4. **HTTPS è¯ä¹¦**ï¼š
   - NPM è‡ªåŠ¨ç®¡ç† Let's Encrypt è¯ä¹¦
   - è¯ä¹¦è‡ªåŠ¨ç»­æœŸï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ

---

## ï¿½ PM2 æŒä¹…åŒ–è¿è¡Œï¼ˆæ¨èï¼‰

### PM2 é…ç½®æ–‡ä»¶

é¡¹ç›®å·²åŒ…å« `ecosystem.config.js`ï¼Œé…ç½®äº†å‰åç«¯ä¸¤ä¸ªè¿›ç¨‹ï¼š

```javascript
module.exports = {
  apps: [
    {
      name: 'game-backend',
      cwd: './server',
      script: 'npm',
      args: 'start',
      env: { NODE_ENV: 'production', PORT: 20002, HOST: '127.0.0.1' }
    },
    {
      name: 'game-frontend',
      cwd: './client',
      script: 'npm',
      args: 'run preview',
      env: { NODE_ENV: 'production' }
    }
  ]
};
```

### ä½¿ç”¨ PM2 ç®¡ç†è„šæœ¬

é¡¹ç›®æä¾›äº† `pm2-manager.sh` è„šæœ¬ï¼Œç®€åŒ– PM2 æ“ä½œï¼š

```bash
# å¯åŠ¨æœåŠ¡ï¼ˆé¦–æ¬¡ä¼šè‡ªåŠ¨æ„å»ºå‰ç«¯ï¼‰
./pm2-manager.sh start

# æŸ¥çœ‹çŠ¶æ€
./pm2-manager.sh status
# è¾“å‡ºç¤ºä¾‹ï¼š
# â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ id  â”‚ name             â”‚ status  â”‚ cpu     â”‚ memory   â”‚
# â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ 0   â”‚ game-backend     â”‚ online  â”‚ 0.2%    â”‚ 45.3 MB  â”‚
# â”‚ 1   â”‚ game-frontend    â”‚ online  â”‚ 0.1%    â”‚ 32.1 MB  â”‚
# â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
./pm2-manager.sh logs              # æ‰€æœ‰æ—¥å¿—
./pm2-manager.sh logs game-backend # ä»…åç«¯æ—¥å¿—

# é‡å¯æœåŠ¡
./pm2-manager.sh restart

# åœæ­¢æœåŠ¡
./pm2-manager.sh stop

# å‰ç«¯ä»£ç æ›´æ–°åé‡æ–°æ„å»º
./pm2-manager.sh rebuild

# ä¿å­˜è¿›ç¨‹åˆ—è¡¨å¹¶é…ç½®å¼€æœºè‡ªå¯
./pm2-manager.sh setup
```

### æ‰‹åŠ¨ä½¿ç”¨ PM2 å‘½ä»¤

å¦‚ä¸ä½¿ç”¨è„šæœ¬ï¼Œå¯ç›´æ¥ä½¿ç”¨ PM2 å‘½ä»¤ï¼š

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
pm2 start ecosystem.config.js

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs
pm2 logs game-backend --lines 100

# é‡å¯ç‰¹å®šæœåŠ¡
pm2 restart game-frontend

# åœæ­¢æ‰€æœ‰æœåŠ¡
pm2 stop all

# åˆ é™¤è¿›ç¨‹
pm2 delete all

# ä¿å­˜è¿›ç¨‹åˆ—è¡¨
pm2 save

# é…ç½®å¼€æœºè‡ªå¯ï¼ˆéœ€è¦ sudoï¼‰
pm2 startup
# æ‰§è¡Œè¾“å‡ºçš„å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
# sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u lanlic --hp /home/lanlic
```

### PM2 æ—¥å¿—ç®¡ç†

æ—¥å¿—æ–‡ä»¶ä½ç½®ï¼ˆé…ç½®åœ¨ ecosystem.config.jsï¼‰ï¼š
- åç«¯é”™è¯¯æ—¥å¿—ï¼š`logs/backend-error.log`
- åç«¯è¾“å‡ºæ—¥å¿—ï¼š`logs/backend-out.log`
- å‰ç«¯é”™è¯¯æ—¥å¿—ï¼š`logs/frontend-error.log`
- å‰ç«¯è¾“å‡ºæ—¥å¿—ï¼š`logs/frontend-out.log`

```bash
# æ¸…ç©ºæ—¥å¿—
pm2 flush

# æ—¥å¿—è½®è½¬ï¼ˆé˜²æ­¢æ—¥å¿—æ–‡ä»¶è¿‡å¤§ï¼‰
pm2 install pm2-logrotate
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7
```

### PM2 ç›‘æ§

```bash
# å®æ—¶ç›‘æ§é¢æ¿
pm2 monit

# Web ç›‘æ§ï¼ˆéœ€è¦ PM2 Plus è´¦å·ï¼‰
pm2 link [secret] [public]
```

---

## ï¿½ğŸ› ï¸ å¸¸è§é—®é¢˜

### Q1: å¤–ç½‘æ— æ³•è®¿é—®ç½‘ç«™

**æ£€æŸ¥é¡¹**ï¼š
1. NPM ä¸­åŸŸåæ˜¯å¦æ­£ç¡®é…ç½®
2. DNS è§£ææ˜¯å¦æŒ‡å‘æœåŠ¡å™¨ IP
3. æœåŠ¡å™¨é˜²ç«å¢™æ˜¯å¦æ”¾è¡Œ 80/443 ç«¯å£
4. å‰ç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼ˆ`lsof -i :20001`ï¼‰

### Q2: API è¯·æ±‚å¤±è´¥ï¼ˆ404 æˆ– 502ï¼‰

**æ£€æŸ¥é¡¹**ï¼š
1. åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œï¼ˆ`lsof -i :20002`ï¼‰
2. NPM Custom Location é…ç½®æ˜¯å¦æ­£ç¡®
3. æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹ç½‘ç»œè¯·æ±‚è·¯å¾„
4. åç«¯æ—¥å¿—æ˜¯å¦æœ‰æŠ¥é”™ä¿¡æ¯

### Q3: ç™»å½•ååŠŸèƒ½å¼‚å¸¸

**æ£€æŸ¥é¡¹**ï¼š
1. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰ CORS é”™è¯¯
2. LocalStorage ä¸­æ˜¯å¦æœ‰ `admin_token`
3. API è¯·æ±‚æ˜¯å¦æ­£ç¡®æºå¸¦ Authorization å¤´
4. åç«¯ token éªŒè¯ä¸­é—´ä»¶æ˜¯å¦æ­£å¸¸å·¥ä½œ

### Q4: ä¿®æ”¹ä»£ç åæœªç”Ÿæ•ˆ

**ä½¿ç”¨ PM2**ï¼š
```bash
# åç«¯ä¿®æ”¹
./pm2-manager.sh restart

# å‰ç«¯ä¿®æ”¹ï¼ˆéœ€é‡æ–°æ„å»ºï¼‰
./pm2-manager.sh rebuild
```

**æ‰‹åŠ¨æ–¹å¼**ï¼š
```bash
# åç«¯ï¼šCtrl+C ç„¶å npm start
# å‰ç«¯ï¼šnpm run build ç„¶åé‡å¯ npm run preview
```

### Q5: PM2 è¿›ç¨‹æ— æ³•å¯åŠ¨

**æ£€æŸ¥é¡¹**ï¼š
1. ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼ˆ`lsof -i :20001` å’Œ `lsof -i :20002`ï¼‰
2. PM2 æ˜¯å¦å·²å…¨å±€å®‰è£…ï¼ˆ`pm2 --version`ï¼‰
3. å‰ç«¯æ˜¯å¦å·²æ„å»ºï¼ˆ`ls client/dist`ï¼‰
4. æŸ¥çœ‹ PM2 æ—¥å¿—ï¼ˆ`./pm2-manager.sh logs`ï¼‰

---

## ğŸ”„ æ›´æ–°éƒ¨ç½²

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
cd /home/lanlic/Html-Project/3b-manage/game-manager
git pull  # å¦‚æœä½¿ç”¨ Git

# 2. æ›´æ–°ä¾èµ–ï¼ˆå¦‚æœ‰ package.json å˜åŒ–ï¼‰
cd server && npm install
cd ../client && npm install

# 3. é‡å¯æœåŠ¡
# PM2 æ–¹å¼
pm2 restart game-backend
pm2 restart game-frontend

# æ‰‹åŠ¨æ–¹å¼
# Ctrl+C åœæ­¢æœåŠ¡ï¼Œç„¶åé‡æ–°è¿è¡Œå¯åŠ¨è„šæœ¬
./start-backend.sh
./start-frontend.sh
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [README.md](../README.md) - é¡¹ç›®æ•´ä½“ä»‹ç»
- [V2.1_UPDATE.md](../V2.1_UPDATE.md) - æƒé™ç³»ç»Ÿæ›´æ–°è¯´æ˜
- [PWA_TEST.md](../PWA_TEST.md) - PWA åŠŸèƒ½æµ‹è¯•æŒ‡å—

---

**éƒ¨ç½²å®Œæˆï¼** ğŸ‰

è®¿é—® `https://3b.1plabs.pro` å¼€å§‹ä½¿ç”¨ã€‚
